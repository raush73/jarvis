<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Timesheet Approval</title>
  <meta name="color-scheme" content="light dark" />
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    body { margin: 0; padding: 16px; background: #f7f7f8; }
    .card { max-width: 520px; margin: 0 auto; background: #fff; border-radius: 14px; padding: 16px; box-shadow: 0 4px 18px rgba(0,0,0,.08); }
    h1 { font-size: 18px; margin: 0 0 10px; }
    .muted { color: #666; font-size: 13px; }
    .row { display: flex; justify-content: space-between; gap: 12px; padding: 10px 0; border-top: 1px solid #eee; }
    .row:first-of-type { border-top: 0; }
    .k { font-weight: 600; }
    .v { text-align: right; }
    .btns { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 14px; }
    button { border: 0; border-radius: 12px; padding: 12px 14px; font-weight: 700; font-size: 15px; cursor: pointer; }
    button:disabled { opacity: .55; cursor: not-allowed; }
    .approve { background: #16a34a; color: #fff; }
    .reject { background: #dc2626; color: #fff; }
    .single { grid-template-columns: 1fr; }
    textarea { width: 100%; min-height: 84px; border-radius: 12px; border: 1px solid #ddd; padding: 10px; font-size: 14px; margin-top: 10px; resize: vertical; }
    .pill { display: inline-block; padding: 6px 10px; border-radius: 999px; font-weight: 700; font-size: 12px; }
    .pill-ok { background: #e7f8ee; color: #0f7a34; }
    .pill-bad { background: #fde8e8; color: #b42318; }
    .pill-warn { background: #fff7ed; color: #9a3412; }
    .footer { margin-top: 12px; font-size: 12px; color: #777; text-align: center; }
    .error { margin-top: 10px; color: #b42318; font-size: 13px; }
    .loading { margin-top: 10px; font-size: 14px; }
  </style>
</head>
<body>
  <div class="card">
    <div style="display:flex; justify-content:space-between; align-items:center; gap:12px;">
      <h1>Timesheet Approval</h1>
      <span id="pill" class="pill pill-warn">Loading</span>
    </div>
    <div class="muted" id="subtitle">Checking link status...</div>

    <div id="content">
      <div class="loading">Loading...</div>
    </div>

    <div class="mini-row">
  <button class="mini-btn" id="refreshBtn" type="button">Refresh</button>
  <button class="mini-btn" id="copyBtn" type="button">Copy Link</button>
</div>
<input class="urlbox" id="urlBox" readonly />
<div class="footer">Powered by Jarvis</div>
  </div>

<script>
(function () {
  const token = (window.__DATA__ && window.__DATA__.token) ? window.__DATA__.token : "";
  const base = "/magic/timesheet-approval/" + encodeURIComponent(token);

  const el = {
    pill: document.getElementById("pill"),
    subtitle: document.getElementById("subtitle"),
    content: document.getElementById("content"),
  };
  // UI-2 helpers
  const refreshBtn = document.getElementById("refreshBtn");
  const copyBtn = document.getElementById("copyBtn");
  const urlBox = document.getElementById("urlBox");

  if (urlBox) urlBox.value = window.location.href;

  if (copyBtn) {
    copyBtn.addEventListener("click", async () => {
      try {
        await navigator.clipboard.writeText(window.location.href);
        copyBtn.textContent = "Copied";
        setTimeout(() => (copyBtn.textContent = "Copy Link"), 1200);
      } catch (e) {
        urlBox && urlBox.select && urlBox.select();
      }
    });
  }

  if (refreshBtn) {
    refreshBtn.addEventListener("click", () => {
      load();
    });
  }

  function setPill(type, text) {
    el.pill.className = "pill " + type;
    el.pill.textContent = text;
  }

  function escapeHtml(str) {
    return String(str ?? "")
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }

  function renderInvalid(msg) {
    setPill("pill-bad", "Invalid");
    el.subtitle.textContent = "This link can't be used.";
    el.content.innerHTML = "<div class='error'>" + escapeHtml(msg) + "</div>";
  }

  
function renderFinalized(state) {
  setPill("pill-ok", "Finalized");
  el.subtitle.textContent = state.message || "This timesheet has already been finalized.";

  const items = Array.isArray(state.items) ? state.items : [];
  const totals = state.totals || {};
  const totalWorkers = totals.totalWorkers ?? items.length;
  const totalHours = totals.totalHours ?? items.reduce((s, x) => s + (Number(x.totalHours) || 0), 0);
  const totalApproved = totals.totalApproved ?? items.filter(x => x.approvalStatus === "APPROVED").length;
  const totalRejected = totals.totalRejected ?? items.filter(x => x.approvalStatus === "REJECTED").length;

  const rows = items.map(it =>
    "<tr>" +
      "<td>" + escapeHtml(it.workerLabel) + "</td>" +
      "<td style='text-align:right'>" + escapeHtml(it.totalHours) + "</td>" +
      "<td style='text-align:right;font-weight:700'>" + escapeHtml(it.approvalStatus || "") + "</td>" +
      "<td>" + escapeHtml(it.rejectionReason || "") + "</td>" +
    "</tr>"
  ).join("");

  const table = items.length ? (
    "<table style='width:100%;border-collapse:collapse'>" +
      "<thead><tr><th>Worker</th><th>Hours</th><th>Status</th><th>Reason</th></tr></thead>" +
      "<tbody>" + rows + "</tbody>" +
    "</table>"
  ) : "";

  el.content.innerHTML = [
    "<div class='row'><div class='k'>Result</div><div class='v'>" + escapeHtml(state.result) + "</div></div>",
    "<div class='row'><div class='k'>Timestamp</div><div class='v'>" + escapeHtml(state.timestamp) + "</div></div>",
    "<div class='row'><div class='k'>Workers</div><div class='v'>" + totalWorkers + "</div></div>",
    "<div class='row'><div class='k'>Total Hours</div><div class='v'>" + totalHours + "</div></div>",
    "<div class='row'><div class='k'>Approved</div><div class='v'>" + totalApproved + "</div></div>",
    "<div class='row'><div class='k'>Rejected</div><div class='v'>" + totalRejected + "</div></div>",
    table
  ].join("");
}

function renderApprovable(state) {
    setPill("pill-warn", "Action Required");
    el.subtitle.textContent = "Approve all or flag exceptions by worker.";

    const items = Array.isArray(state.items) ? state.items : [];
    const totals = state.totals || {};
    const totalWorkers = totals.totalWorkers ?? items.length;
    const totalHours = totals.totalHours ?? items.reduce((s, x) => s + (Number(x.totalHours) || 0), 0);

    // Track exceptions (reject) with optional reason
    const ex = new Map(); // hoursEntryId -> { hoursEntryId, action:"REJECT", reason? }

    function render() {
      const rows = items.map((it, idx) => {
        const id = it.hoursEntryId;
        const checked = ex.has(id) ? "checked" : "";
        const reasonVal = ex.get(id)?.reason ?? "";
        const disabled = ex.has(id) ? "" : "disabled";

        return (
          "<tr>" +
            "<td style='padding:10px 8px; border-top:1px solid #eee;'>" + escapeHtml(it.workerLabel) + "</td>" +
            "<td style='padding:10px 8px; border-top:1px solid #eee; text-align:right;'>" + escapeHtml(it.totalHours) + "</td>" +
            "<td style='padding:10px 8px; border-top:1px solid #eee; text-align:center;'>" +
              "<input type='checkbox' data-flag='1' data-id='" + escapeHtml(id) + "' " + checked + " />" +
            "</td>" +
            "<td style='padding:10px 8px; border-top:1px solid #eee;'>" +
              "<input type='text' data-reason='1' data-id='" + escapeHtml(id) + "' value='" + escapeHtml(reasonVal) + "' " + disabled + " " +
              "style='width:100%; border:1px solid #ddd; border-radius:10px; padding:8px; font-size:14px;' " +
              "placeholder='Reason (optional)' />" +
            "</td>" +
          "</tr>"
        );
      }).join("");

      const table = (
        "<div style='margin-top:10px; overflow-x:auto;'>" +
          "<table style='width:100%; border-collapse:collapse; font-size:14px; background:#fff; border-radius:12px; overflow:hidden;'>" +
            "<thead>" +
              "<tr style='background:#fafafa;'>" +
                "<th style='text-align:left; padding:10px 8px;'>Worker</th>" +
                "<th style='text-align:right; padding:10px 8px;'>Hours</th>" +
                "<th style='text-align:center; padding:10px 8px;'>Flag</th>" +
                "<th style='text-align:left; padding:10px 8px;'>Exception Reason</th>" +
              "</tr>" +
            "</thead>" +
            "<tbody>" + (rows || "<tr><td colspan='4' style='padding:10px 8px;'>No items.</td></tr>") + "</tbody>" +
          "</table>" +
        "</div>"
      );

      const summary = [
        "<div class='row'><div class='k'>Customer</div><div class='v'>" + escapeHtml(state.customerName) + "</div></div>",
        "<div class='row'><div class='k'>Order</div><div class='v'>" + escapeHtml(state.orderName) + "</div></div>",
        "<div class='row'><div class='k'>Payroll Week</div><div class='v'>" + escapeHtml(state.payrollWeek) + "</div></div>",
        "<div class='row'><div class='k'>Workers</div><div class='v'>" + escapeHtml(totalWorkers) + "</div></div>",
        "<div class='row'><div class='k'>Total Hours</div><div class='v'>" + escapeHtml(totalHours) + "</div></div>",
      ].join("");

      el.content.innerHTML = [
        summary,
        table,
        "<textarea id='comment' placeholder='Optional overall comment (visible to MW4H)'></textarea>",
        "<div class='btns' id='btns'>",
          "<button class='reject' id='rejectBtn'>Reject All</button>",
          "<button class='approve' id='approveBtn'>Approve / Approve w/ Exceptions</button>",
        "</div>",
        "<div class='error' id='err' style='display:none;'></div>"
      ].join("");

      // wire events
      document.querySelectorAll("input[data-flag='1']").forEach((cb) => {
        cb.addEventListener("change", (e) => {
          const id = e.target.getAttribute("data-id");
          const on = !!e.target.checked;
          if (on) ex.set(id, { hoursEntryId: id, action: "REJECT" });
          else ex.delete(id);
          render();
        });
      });

      document.querySelectorAll("input[data-reason='1']").forEach((inp) => {
        inp.addEventListener("input", (e) => {
          const id = e.target.getAttribute("data-id");
          if (!ex.has(id)) return;
          const cur = ex.get(id);
          cur.reason = e.target.value || undefined;
          ex.set(id, cur);
        });
      });

      const approveBtn = document.getElementById("approveBtn");
      const rejectBtn = document.getElementById("rejectBtn");
      const commentEl = document.getElementById("comment");
      const errEl = document.getElementById("err");

      function setBusy(busy) {
        approveBtn.disabled = busy;
        rejectBtn.disabled = busy;
        commentEl.disabled = busy;
      }

      async function submit(action) {
        setPill("pill-warn", "Submitting...");
        errEl.style.display = "none";
        setBusy(true);
        try {
          const exceptions = Array.from(ex.values());
          const payload = {
            action,
            comment: commentEl.value || undefined,
            exceptions: exceptions.length ? exceptions : undefined,
          };

          const res = await fetch(base, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });

          const json = await res.json();

          if (!json || !json.state) {
            renderInvalid("Unexpected response.");
            return;
          }

          if (json.state === "FINALIZED") renderFinalized(json);
          else if (json.state === "INVALID") renderInvalid(json.message || "Invalid link.");
          else renderInvalid("Unexpected state.");
        } catch (e) {
          errEl.textContent = "Network error. Please try again.";
          errEl.style.display = "block";
        } finally {
          setBusy(false);
        }
      }

      approveBtn.addEventListener("click", () => submit("APPROVE"));
      rejectBtn.addEventListener("click", () => submit("REJECT"));
    }

    render();
  }
  async function load() {
    try {
      const res = await fetch(base, { method: "GET" });
      const json = await res.json();

      if (!json || !json.state) {
        renderInvalid("Unexpected response.");
        return;
      }

      if (json.state === "INVALID") renderInvalid(json.message || "Invalid link.");
      else if (json.state === "FINALIZED") renderFinalized(json);
      else if (json.state === "APPROVABLE") renderApprovable(json);
      else renderInvalid("Unknown state.");
    } catch (e) {
      renderInvalid("Network error. Please refresh and try again.");
    }
  }

  load();
})();
</script>
</body>
</html>
