<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Submit Hours (Reference Only)</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background-color: #f5f5f5;
      padding: 1rem;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .container {
      max-width: 600px;
      margin: 0 auto;
      width: 100%;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      padding: 1.5rem;
    }

    h1 {
      font-size: 1.5rem;
      margin-bottom: 1.5rem;
      color: #333;
      text-align: center;
    }

    .form-group {
      margin-bottom: 1.25rem;
    }

    label {
      display: block;
      margin-bottom: 0.5rem;
      color: #333;
      font-weight: 500;
      font-size: 0.9rem;
    }

    .required::after {
      content: ' *';
      color: #e74c3c;
    }

    input[type="date"],
    input[type="time"],
    input[type="number"],
    textarea {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 1rem;
      font-family: inherit;
    }

    input:focus,
    textarea:focus {
      outline: none;
      border-color: #4a90e2;
      box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.1);
    }

    textarea {
      min-height: 100px;
      resize: vertical;
    }

    .mode-selector {
      display: flex;
      gap: 1rem;
      margin-top: 0.5rem;
    }

    .mode-option {
      flex: 1;
    }

    .mode-option input[type="radio"] {
      margin-right: 0.5rem;
    }

    .mode-inputs {
      margin-top: 0.75rem;
    }

    .mode-inputs.hidden {
      display: none;
    }

    .error-message {
      color: #e74c3c;
      font-size: 0.875rem;
      margin-top: 0.5rem;
      display: none;
    }

    .error-message.show {
      display: block;
    }

    .success-message {
      background-color: #d4edda;
      color: #155724;
      padding: 1rem;
      border-radius: 4px;
      margin-bottom: 1rem;
      display: none;
    }

    .success-message.show {
      display: block;
    }

    .error-alert {
      background-color: #f8d7da;
      color: #721c24;
      padding: 1rem;
      border-radius: 4px;
      margin-bottom: 1rem;
      display: none;
    }

    .error-alert.show {
      display: block;
    }

    button[type="submit"] {
      width: 100%;
      padding: 0.875rem;
      background-color: #4a90e2;
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 1rem;
      font-weight: 500;
      cursor: pointer;
      transition: background-color 0.2s;
      margin-top: 0.5rem;
    }

    button[type="submit"]:hover:not(:disabled) {
      background-color: #357abd;
    }

    button[type="submit"]:disabled {
      background-color: #ccc;
      cursor: not-allowed;
      opacity: 0.6;
    }

    @media (min-width: 480px) {
      body {
        padding: 2rem 1rem;
      }

      .container {
        padding: 2rem;
      }

      h1 {
        font-size: 1.75rem;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Submit Hours (Reference Only)</h1>

    <div id="successMessage" class="success-message">
      Your hours have been submitted successfully!
    </div>

    <div id="errorAlert" class="error-alert"></div>

    <form id="hoursForm">
      <div class="form-group">
        <label for="workDate" class="required">Work Date</label>
        <input type="date" id="workDate" name="workDate" required>
        <div class="error-message" id="workDateError"></div>
      </div>

      <div class="form-group">
        <label class="required">Time Entry Mode</label>
        <div class="mode-selector">
          <div class="mode-option">
            <input type="radio" id="modeMinutes" name="mode" value="minutes" checked>
            <label for="modeMinutes" style="display: inline; font-weight: normal;">Total Minutes</label>
          </div>
          <div class="mode-option">
            <input type="radio" id="modeTimes" name="mode" value="times">
            <label for="modeTimes" style="display: inline; font-weight: normal;">Start/End Time</label>
          </div>
        </div>

        <div id="minutesInput" class="mode-inputs">
          <label for="totalMinutes" class="required" style="margin-top: 0.75rem;">Total Minutes</label>
          <input type="number" id="totalMinutes" name="totalMinutes" min="0" step="1">
          <div class="error-message" id="totalMinutesError"></div>
        </div>

        <div id="timesInput" class="mode-inputs hidden">
          <label for="startTime" class="required" style="margin-top: 0.75rem;">Start Time</label>
          <input type="time" id="startTime" name="startTime">
          <div class="error-message" id="startTimeError"></div>

          <label for="endTime" class="required" style="margin-top: 0.75rem;">End Time</label>
          <input type="time" id="endTime" name="endTime">
          <div class="error-message" id="endTimeError"></div>
        </div>
      </div>

      <div class="form-group">
        <label for="note">Note (Optional)</label>
        <textarea id="note" name="note" placeholder="Add any additional notes..."></textarea>
      </div>

      <button type="submit" id="submitBtn">Submit</button>
    </form>
  </div>

  <script>
    (function() {
      // Extract token from URL path
      const pathParts = window.location.pathname.split('/');
      const tokenIndex = pathParts.indexOf('employee-hours-self-report');
      const token = tokenIndex >= 0 && pathParts[tokenIndex + 1] ? pathParts[tokenIndex + 1] : null;

      if (!token) {
        document.getElementById('errorAlert').textContent = 'Invalid link: token not found in URL.';
        document.getElementById('errorAlert').classList.add('show');
        document.getElementById('submitBtn').disabled = true;
      }

      const form = document.getElementById('hoursForm');
      const submitBtn = document.getElementById('submitBtn');
      const successMessage = document.getElementById('successMessage');
      const errorAlert = document.getElementById('errorAlert');
      const modeRadios = document.querySelectorAll('input[name="mode"]');
      const minutesInput = document.getElementById('minutesInput');
      const timesInput = document.getElementById('timesInput');

      // Handle mode switching
      modeRadios.forEach(radio => {
        radio.addEventListener('change', function() {
          if (this.value === 'minutes') {
            minutesInput.classList.remove('hidden');
            timesInput.classList.add('hidden');
            document.getElementById('totalMinutes').required = true;
            document.getElementById('startTime').required = false;
            document.getElementById('endTime').required = false;
          } else {
            minutesInput.classList.add('hidden');
            timesInput.classList.remove('hidden');
            document.getElementById('totalMinutes').required = false;
            document.getElementById('startTime').required = true;
            document.getElementById('endTime').required = true;
          }
          // Clear errors when switching modes
          clearFieldErrors();
        });
      });

      // Initialize mode on load
      if (document.getElementById('modeMinutes').checked) {
        document.getElementById('totalMinutes').required = true;
      } else {
        document.getElementById('startTime').required = true;
        document.getElementById('endTime').required = true;
      }

      function clearFieldErrors() {
        document.querySelectorAll('.error-message').forEach(el => {
          el.classList.remove('show');
          el.textContent = '';
        });
        errorAlert.classList.remove('show');
        errorAlert.textContent = '';
      }

      function showFieldError(fieldId, message) {
        const errorEl = document.getElementById(fieldId + 'Error');
        if (errorEl) {
          errorEl.textContent = message;
          errorEl.classList.add('show');
        }
      }

      function validateForm() {
        clearFieldErrors();
        let isValid = true;

        const workDate = document.getElementById('workDate').value;
        if (!workDate) {
          showFieldError('workDate', 'Work date is required');
          isValid = false;
        }

        const mode = document.querySelector('input[name="mode"]:checked').value;
        if (mode === 'minutes') {
          const totalMinutes = document.getElementById('totalMinutes').value;
          if (!totalMinutes || totalMinutes <= 0) {
            showFieldError('totalMinutes', 'Total minutes must be greater than 0');
            isValid = false;
          }
        } else {
          const startTime = document.getElementById('startTime').value;
          const endTime = document.getElementById('endTime').value;
          if (!startTime) {
            showFieldError('startTime', 'Start time is required');
            isValid = false;
          }
          if (!endTime) {
            showFieldError('endTime', 'End time is required');
            isValid = false;
          }
          if (startTime && endTime && startTime >= endTime) {
            showFieldError('endTime', 'End time must be after start time');
            isValid = false;
          }
        }

        return isValid;
      }

      form.addEventListener('submit', async function(e) {
        e.preventDefault();

        if (!validateForm()) {
          return;
        }

        if (!token) {
          errorAlert.textContent = 'Invalid link: token not found in URL.';
          errorAlert.classList.add('show');
          return;
        }

        submitBtn.disabled = true;
        successMessage.classList.remove('show');
        errorAlert.classList.remove('show');

        const mode = document.querySelector('input[name="mode"]:checked').value;
        const payload = {
          workDate: document.getElementById('workDate').value,
          note: document.getElementById('note').value || undefined
        };

        if (mode === 'minutes') {
          payload.totalMinutes = parseInt(document.getElementById('totalMinutes').value, 10);
        } else {
          payload.startTime = document.getElementById('startTime').value;
          payload.endTime = document.getElementById('endTime').value;
        }

        try {
          const response = await fetch(`/magic/employee-hours/${token}`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(payload)
          });

          if (response.ok) {
            successMessage.classList.add('show');
            form.reset();
            clearFieldErrors();
            // Reset mode to default
            document.getElementById('modeMinutes').checked = true;
            minutesInput.classList.remove('hidden');
            timesInput.classList.add('hidden');
            document.getElementById('totalMinutes').required = true;
            document.getElementById('startTime').required = false;
            document.getElementById('endTime').required = false;
          } else if (response.status === 400 || response.status === 401) {
            const errorData = await response.json().catch(() => ({}));
            const errorMessage = errorData.message || 'An error occurred while submitting hours.';
            errorAlert.textContent = errorMessage;
            errorAlert.classList.add('show');
          } else {
            errorAlert.textContent = 'An unexpected error occurred. Please try again.';
            errorAlert.classList.add('show');
          }
        } catch (error) {
          errorAlert.textContent = 'Network error. Please check your connection and try again.';
          errorAlert.classList.add('show');
        } finally {
          submitBtn.disabled = false;
        }
      });
    })();
  </script>
</body>
</html>

