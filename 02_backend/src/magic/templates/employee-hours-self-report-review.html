<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Your Submitted Hours</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background-color: #f5f5f5;
      padding: 1rem;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .container {
      max-width: 600px;
      margin: 0 auto;
      width: 100%;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      padding: 1.5rem;
    }

    h1 {
      font-size: 1.5rem;
      margin-bottom: 1rem;
      color: #333;
      text-align: center;
    }

    .status-indicator {
      text-align: center;
      padding: 0.75rem;
      margin-bottom: 1.5rem;
      border-radius: 4px;
      font-size: 0.9rem;
      font-weight: 500;
    }

    .status-indicator.editable {
      background-color: #d4edda;
      color: #155724;
    }

    .status-indicator.locked {
      background-color: #f8d7da;
      color: #721c24;
    }

    .form-group {
      margin-bottom: 1.25rem;
    }

    label {
      display: block;
      margin-bottom: 0.5rem;
      color: #333;
      font-weight: 500;
      font-size: 0.9rem;
    }

    .read-only-value {
      padding: 0.75rem;
      background-color: #f8f9fa;
      border: 1px solid #e9ecef;
      border-radius: 4px;
      color: #495057;
      font-size: 1rem;
    }

    input[type="date"],
    input[type="time"],
    input[type="number"],
    textarea {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 1rem;
      font-family: inherit;
    }

    input:focus,
    textarea:focus {
      outline: none;
      border-color: #4a90e2;
      box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.1);
    }

    textarea {
      min-height: 100px;
      resize: vertical;
    }

    .mode-inputs {
      margin-top: 0.75rem;
    }

    .mode-inputs.hidden {
      display: none;
    }

    .error-message {
      color: #e74c3c;
      font-size: 0.875rem;
      margin-top: 0.5rem;
      display: none;
    }

    .error-message.show {
      display: block;
    }

    .success-message {
      background-color: #d4edda;
      color: #155724;
      padding: 1rem;
      border-radius: 4px;
      margin-bottom: 1rem;
      display: none;
    }

    .success-message.show {
      display: block;
    }

    .error-alert {
      background-color: #f8d7da;
      color: #721c24;
      padding: 1rem;
      border-radius: 4px;
      margin-bottom: 1rem;
      display: none;
    }

    .error-alert.show {
      display: block;
    }

    .button-group {
      display: flex;
      gap: 0.75rem;
      margin-top: 1rem;
    }

    button {
      flex: 1;
      padding: 0.875rem;
      border: none;
      border-radius: 4px;
      font-size: 1rem;
      font-weight: 500;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    button:hover:not(:disabled) {
      opacity: 0.9;
    }

    button:disabled {
      background-color: #ccc;
      cursor: not-allowed;
      opacity: 0.6;
    }

    .btn-edit {
      background-color: #4a90e2;
      color: white;
    }

    .btn-edit:hover:not(:disabled) {
      background-color: #357abd;
    }

    .btn-save {
      background-color: #16a34a;
      color: white;
    }

    .btn-save:hover:not(:disabled) {
      background-color: #15803d;
    }

    .btn-cancel {
      background-color: #6c757d;
      color: white;
    }

    .btn-cancel:hover:not(:disabled) {
      background-color: #5a6268;
    }

    .btn-locked {
      background-color: #6c757d;
      color: white;
      cursor: not-allowed;
    }

    .hidden {
      display: none;
    }

    @media (min-width: 480px) {
      body {
        padding: 2rem 1rem;
      }

      .container {
        padding: 2rem;
      }

      h1 {
        font-size: 1.75rem;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Your Submitted Hours</h1>

    <div id="statusIndicator" class="status-indicator">
      Loading...
    </div>

    <div id="successMessage" class="success-message">
      Your hours have been updated successfully!
    </div>

    <div id="errorAlert" class="error-alert"></div>

    <form id="hoursForm">
      <div class="form-group">
        <label for="workDate">Work Date</label>
        <div id="workDateDisplay" class="read-only-value"></div>
        <input type="date" id="workDate" name="workDate" required style="display: none;">
        <div class="error-message" id="workDateError"></div>
      </div>

      <div class="form-group">
        <label id="timeEntryLabel">Time Entry</label>
        
        <div id="totalMinutesDisplay" class="read-only-value" style="display: none;"></div>
        <div id="timesDisplay" style="display: none;">
          <div style="margin-bottom: 0.75rem;">
            <label for="startTimeDisplay" style="margin-bottom: 0.25rem; font-size: 0.85rem;">Start Time</label>
            <div id="startTimeDisplay" class="read-only-value"></div>
          </div>
          <div>
            <label for="endTimeDisplay" style="margin-bottom: 0.25rem; font-size: 0.85rem;">End Time</label>
            <div id="endTimeDisplay" class="read-only-value"></div>
          </div>
        </div>

        <div id="editModeInputs" style="display: none;">
          <div class="mode-inputs" id="minutesInput">
            <label for="totalMinutes" class="required">Total Minutes</label>
            <input type="number" id="totalMinutes" name="totalMinutes" min="0" step="1">
            <div class="error-message" id="totalMinutesError"></div>
          </div>

          <div class="mode-inputs hidden" id="timesInput">
            <label for="startTime" class="required">Start Time</label>
            <input type="time" id="startTime" name="startTime">
            <div class="error-message" id="startTimeError"></div>

            <label for="endTime" class="required" style="margin-top: 0.75rem;">End Time</label>
            <input type="time" id="endTime" name="endTime">
            <div class="error-message" id="endTimeError"></div>
          </div>
        </div>
      </div>

      <div class="form-group">
        <label for="note">Note</label>
        <div id="noteDisplay" class="read-only-value" style="min-height: 100px;"></div>
        <textarea id="note" name="note" placeholder="Add any additional notes..." style="display: none;"></textarea>
      </div>

      <div class="form-group">
        <label>Submitted At</label>
        <div id="submittedAtDisplay" class="read-only-value"></div>
      </div>

      <div class="button-group">
        <button type="button" id="editBtn" class="btn-edit" style="display: none;">Edit</button>
        <button type="button" id="saveBtn" class="btn-save" style="display: none;">Save Changes</button>
        <button type="button" id="cancelBtn" class="btn-cancel" style="display: none;">Cancel</button>
        <button type="button" id="lockedBtn" class="btn-locked" style="display: none;" disabled>Locked</button>
      </div>
    </form>
  </div>

  <script>
    (function() {
      // Extract token from URL path
      const pathParts = window.location.pathname.split('/');
      const tokenIndex = pathParts.indexOf('employee-hours-self-report-review');
      const token = tokenIndex >= 0 && pathParts[tokenIndex + 1] ? pathParts[tokenIndex + 1] : null;

      if (!token) {
        document.getElementById('errorAlert').textContent = 'Invalid link: token not found in URL.';
        document.getElementById('errorAlert').classList.add('show');
        return;
      }

      let currentData = null;
      let isEditable = false;
      let isEditMode = false;

      const statusIndicator = document.getElementById('statusIndicator');
      const successMessage = document.getElementById('successMessage');
      const errorAlert = document.getElementById('errorAlert');
      const form = document.getElementById('hoursForm');
      const editBtn = document.getElementById('editBtn');
      const saveBtn = document.getElementById('saveBtn');
      const cancelBtn = document.getElementById('cancelBtn');
      const lockedBtn = document.getElementById('lockedBtn');

      // Display elements
      const workDateDisplay = document.getElementById('workDateDisplay');
      const workDateInput = document.getElementById('workDate');
      const totalMinutesDisplay = document.getElementById('totalMinutesDisplay');
      const timesDisplay = document.getElementById('timesDisplay');
      const startTimeDisplay = document.getElementById('startTimeDisplay');
      const endTimeDisplay = document.getElementById('endTimeDisplay');
      const noteDisplay = document.getElementById('noteDisplay');
      const noteInput = document.getElementById('note');
      const submittedAtDisplay = document.getElementById('submittedAtDisplay');

      // Edit mode inputs
      const editModeInputs = document.getElementById('editModeInputs');
      const totalMinutesInput = document.getElementById('totalMinutes');
      const startTimeInput = document.getElementById('startTime');
      const endTimeInput = document.getElementById('endTime');
      const minutesInputDiv = document.getElementById('minutesInput');
      const timesInputDiv = document.getElementById('timesInput');

      function clearErrors() {
        document.querySelectorAll('.error-message').forEach(el => {
          el.classList.remove('show');
          el.textContent = '';
        });
        errorAlert.classList.remove('show');
        errorAlert.textContent = '';
      }

      function showFieldError(fieldId, message) {
        const errorEl = document.getElementById(fieldId + 'Error');
        if (errorEl) {
          errorEl.textContent = message;
          errorEl.classList.add('show');
        }
      }

      function isSameCalendarDay(date1, date2) {
        if (!date1 || !date2) return false;
        const d1 = new Date(date1);
        const d2 = new Date(date2);
        return d1.getFullYear() === d2.getFullYear() &&
               d1.getMonth() === d2.getMonth() &&
               d1.getDate() === d2.getDate();
      }

      function formatDateTime(dateString) {
        if (!dateString) return '';
        const date = new Date(dateString);
        return date.toLocaleString();
      }

      function formatTime(isoString) {
        if (!isoString) return '';
        const date = new Date(isoString);
        const hours = String(date.getHours()).padStart(2, '0');
        const minutes = String(date.getMinutes()).padStart(2, '0');
        return `${hours}:${minutes}`;
      }

      function renderReadOnly(data) {
        // Work Date
        const workDate = data.workDate ? new Date(data.workDate).toISOString().split('T')[0] : '';
        workDateDisplay.textContent = workDate || 'Not provided';
        workDateInput.value = workDate;

        // Time Entry
        if (data.totalMinutes !== null && data.totalMinutes !== undefined) {
          totalMinutesDisplay.textContent = `${data.totalMinutes} minutes`;
          totalMinutesDisplay.style.display = 'block';
          timesDisplay.style.display = 'none';
        } else if (data.startTime && data.endTime) {
          startTimeDisplay.textContent = formatTime(data.startTime);
          endTimeDisplay.textContent = formatTime(data.endTime);
          totalMinutesDisplay.style.display = 'none';
          timesDisplay.style.display = 'block';
        } else {
          totalMinutesDisplay.textContent = 'Not provided';
          totalMinutesDisplay.style.display = 'block';
          timesDisplay.style.display = 'none';
        }

        // Note
        noteDisplay.textContent = data.note || 'No note provided';

        // Submitted At
        const submittedAt = data.createdAt || data.submittedAt;
        submittedAtDisplay.textContent = submittedAt ? formatDateTime(submittedAt) : 'Unknown';

        // Populate edit inputs
        if (data.totalMinutes !== null && data.totalMinutes !== undefined) {
          totalMinutesInput.value = data.totalMinutes;
        }
        if (data.startTime) {
          const startDate = new Date(data.startTime);
          startTimeInput.value = `${String(startDate.getHours()).padStart(2, '0')}:${String(startDate.getMinutes()).padStart(2, '0')}`;
        }
        if (data.endTime) {
          const endDate = new Date(data.endTime);
          endTimeInput.value = `${String(endDate.getHours()).padStart(2, '0')}:${String(endDate.getMinutes()).padStart(2, '0')}`;
        }
        noteInput.value = data.note || '';

        // Determine edit eligibility
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const workDateObj = data.workDate ? new Date(data.workDate) : null;
        if (workDateObj) {
          workDateObj.setHours(0, 0, 0, 0);
          isEditable = isSameCalendarDay(workDateObj, today);
        } else {
          isEditable = false;
        }

        // Update status indicator
        if (isEditable) {
          statusIndicator.textContent = 'Editable until end of day';
          statusIndicator.className = 'status-indicator editable';
          editBtn.style.display = 'block';
          lockedBtn.style.display = 'none';
        } else {
          statusIndicator.textContent = 'Locked';
          statusIndicator.className = 'status-indicator locked';
          editBtn.style.display = 'none';
          lockedBtn.style.display = 'block';
        }

        saveBtn.style.display = 'none';
        cancelBtn.style.display = 'none';
        isEditMode = false;
      }

      function enterEditMode() {
        isEditMode = true;
        
        // Hide read-only displays
        workDateDisplay.style.display = 'none';
        totalMinutesDisplay.style.display = 'none';
        timesDisplay.style.display = 'none';
        noteDisplay.style.display = 'none';

        // Show edit inputs
        workDateInput.style.display = 'block';
        editModeInputs.style.display = 'block';

        // Show appropriate time entry mode
        if (currentData.totalMinutes !== null && currentData.totalMinutes !== undefined) {
          minutesInputDiv.classList.remove('hidden');
          timesInputDiv.classList.add('hidden');
          totalMinutesInput.required = true;
          startTimeInput.required = false;
          endTimeInput.required = false;
        } else {
          minutesInputDiv.classList.add('hidden');
          timesInputDiv.classList.remove('hidden');
          totalMinutesInput.required = false;
          startTimeInput.required = true;
          endTimeInput.required = true;
        }

        noteInput.style.display = 'block';

        // Update buttons
        editBtn.style.display = 'none';
        saveBtn.style.display = 'block';
        cancelBtn.style.display = 'block';
        lockedBtn.style.display = 'none';
      }

      function exitEditMode() {
        isEditMode = false;
        
        // Show read-only displays
        workDateDisplay.style.display = 'block';
        if (currentData.totalMinutes !== null && currentData.totalMinutes !== undefined) {
          totalMinutesDisplay.style.display = 'block';
          timesDisplay.style.display = 'none';
        } else {
          totalMinutesDisplay.style.display = 'none';
          timesDisplay.style.display = 'block';
        }
        noteDisplay.style.display = 'block';

        // Hide edit inputs
        workDateInput.style.display = 'none';
        editModeInputs.style.display = 'none';
        noteInput.style.display = 'none';

        // Restore original values
        renderReadOnly(currentData);

        clearErrors();
      }

      function validateForm() {
        clearErrors();
        let isValid = true;

        const workDate = workDateInput.value;
        if (!workDate) {
          showFieldError('workDate', 'Work date is required');
          isValid = false;
        }

        const hasTotalMinutes = totalMinutesInput.value && !minutesInputDiv.classList.contains('hidden');
        const hasStartTime = startTimeInput.value && !timesInputDiv.classList.contains('hidden');
        const hasEndTime = endTimeInput.value && !timesInputDiv.classList.contains('hidden');

        if (hasTotalMinutes) {
          const totalMinutes = parseInt(totalMinutesInput.value, 10);
          if (!totalMinutes || totalMinutes <= 0) {
            showFieldError('totalMinutes', 'Total minutes must be greater than 0');
            isValid = false;
          }
        } else if (hasStartTime || hasEndTime) {
          if (!hasStartTime) {
            showFieldError('startTime', 'Start time is required');
            isValid = false;
          }
          if (!hasEndTime) {
            showFieldError('endTime', 'End time is required');
            isValid = false;
          }
          if (hasStartTime && hasEndTime && startTimeInput.value >= endTimeInput.value) {
            showFieldError('endTime', 'End time must be after start time');
            isValid = false;
          }
        } else {
          showFieldError('totalMinutes', 'Either total minutes or both start/end times are required');
          isValid = false;
        }

        return isValid;
      }

      editBtn.addEventListener('click', function() {
        if (isEditable && !isEditMode) {
          enterEditMode();
        }
      });

      cancelBtn.addEventListener('click', function() {
        if (isEditMode) {
          exitEditMode();
        }
      });

      saveBtn.addEventListener('click', async function(e) {
        e.preventDefault();

        if (!isEditMode || !isEditable) {
          return;
        }

        if (!validateForm()) {
          return;
        }

        saveBtn.disabled = true;
        successMessage.classList.remove('show');
        errorAlert.classList.remove('show');

        const workDate = workDateInput.value;
        const hasTotalMinutes = !minutesInputDiv.classList.contains('hidden');
        
        const payload = {
          workDate: workDate,
          note: noteInput.value || undefined
        };

        if (hasTotalMinutes) {
          payload.totalMinutes = parseInt(totalMinutesInput.value, 10);
        } else {
          // Combine workDate with time inputs to create ISO datetime strings
          const workDateStr = workDate;
          const startTimeStr = startTimeInput.value;
          const endTimeStr = endTimeInput.value;
          
          // Create ISO datetime strings: workDate + time in local timezone
          const startDateTimeStr = `${workDateStr}T${startTimeStr}:00`;
          const endDateTimeStr = `${workDateStr}T${endTimeStr}:00`;
          
          // Validate end > start, and handle next-day cases
          const startDateTime = new Date(startDateTimeStr);
          let endDateTime = new Date(endDateTimeStr);
          
          if (endDateTime <= startDateTime) {
            // End time is before or equal to start, assume next day
            endDateTime = new Date(endDateTimeStr);
            endDateTime.setDate(endDateTime.getDate() + 1);
          }

          payload.startTime = startDateTime.toISOString();
          payload.endTime = endDateTime.toISOString();
        }

        try {
          const response = await fetch(`/magic/employee-hours/${token}`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(payload)
          });

          if (response.ok) {
            const responseData = await response.json();
            currentData = {
              ...responseData,
              createdAt: currentData?.createdAt || new Date().toISOString()
            };
            successMessage.classList.add('show');
            exitEditMode();
            
            // Reload data to get updated timestamps
            setTimeout(() => {
              loadData();
            }, 1000);
          } else if (response.status === 400 || response.status === 401) {
            const errorData = await response.json().catch(() => ({}));
            const errorMessage = errorData.message || 'An error occurred while updating hours.';
            errorAlert.textContent = errorMessage;
            errorAlert.classList.add('show');
          } else {
            errorAlert.textContent = 'An unexpected error occurred. Please try again.';
            errorAlert.classList.add('show');
          }
        } catch (error) {
          errorAlert.textContent = 'Network error. Please check your connection and try again.';
          errorAlert.classList.add('show');
        } finally {
          saveBtn.disabled = false;
        }
      });

      async function loadData() {
        try {
          // Try GET endpoint first
          let response = await fetch(`/magic/employee-hours/${token}`, {
            method: 'GET',
            headers: {
              'Content-Type': 'application/json'
            }
          });

          // If GET fails, the endpoint might not exist yet - this is expected
          if (!response.ok && response.status === 404) {
            // Fallback: Could show a message or assume no data exists yet
            errorAlert.textContent = 'No submission found. Please use the submission form first.';
            errorAlert.classList.add('show');
            return;
          }

          if (response.ok) {
            const data = await response.json();
            currentData = data;
            renderReadOnly(data);
          } else {
            throw new Error('Failed to load data');
          }
        } catch (error) {
          errorAlert.textContent = 'Failed to load submitted hours. Please check your connection and try again.';
          errorAlert.classList.add('show');
        }
      }

      loadData();
    })();
  </script>
</body>
</html>

