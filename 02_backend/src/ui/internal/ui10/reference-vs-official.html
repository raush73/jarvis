<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Reference vs Official Hours (MW4H)</title>
  <style>
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;background:#f5f5f5;margin:0;padding:16px}
    .wrap{max-width:980px;margin:0 auto;background:#fff;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,.08);padding:18px}
    h1{font-size:18px;margin:0 0 8px;color:#111}
    .sub{font-size:13px;color:#444;margin:0 0 14px}
    .pill{display:inline-block;font-size:12px;padding:4px 8px;border-radius:999px;background:#eef2ff;color:#1f2937;margin-left:8px}
    .grid{display:grid;grid-template-columns:1fr;gap:14px}
    .card{border:1px solid #e5e7eb;border-radius:10px;padding:12px}
    .card h2{font-size:14px;margin:0 0 10px;color:#111}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid #eee;padding:8px 6px;font-size:13px;text-align:left;vertical-align:top}
    th{color:#374151;font-weight:600;background:#fafafa}
    .muted{color:#6b7280}
    .right{text-align:right}
    .warn{font-weight:700}
    .ok{font-weight:700}
    .note{font-size:12px;color:#6b7280;margin-top:10px}
    @media (min-width: 900px){.grid{grid-template-columns:1fr 1fr}}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Reference vs Official Hours <span class="pill">MW4H Internal</span></h1>
    <p class="sub" id="subline">Loading…</p>

    <div class="grid">
      <div class="card">
        <h2>Employee Reference (Self-Reported)</h2>
        <div id="refEmpty" class="muted" style="display:none;">No reference hours found for this week.</div>
        <table id="refTable" style="display:none;">
          <thead>
            <tr>
              <th>Worker</th>
              <th>Day</th>
              <th class="right">Minutes</th>
              <th class="right">Hours</th>
              <th>Note</th>
            </tr>
          </thead>
          <tbody id="refTbody"></tbody>
          <tfoot>
            <tr>
              <th colspan="2" class="right">Total</th>
              <th id="refTotalMin" class="right"></th>
              <th id="refTotalHr" class="right"></th>
              <th></th>
            </tr>
          </tfoot>
        </table>
      </div>

      <div class="card">
        <h2>Official (Approved)</h2>
        <div id="offEmpty" class="muted" style="display:none;">No official approved hours found for this week.</div>
        <table id="offTable" style="display:none;">
          <thead>
            <tr>
              <th>Worker</th>
              <th class="right">Hours</th>
              <th class="right">Created</th>
            </tr>
          </thead>
          <tbody id="offTbody"></tbody>
          <tfoot>
            <tr>
              <th class="right">Total</th>
              <th id="offTotalHr" class="right"></th>
              <th></th>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>

    <div class="card" style="margin-top:14px;">
      <h2>Mismatch Summary</h2>
      <div id="mmEmpty" class="muted" style="display:none;">No mismatches detected (or insufficient data).</div>
      <table id="mmTable" style="display:none;">
        <thead>
          <tr>
            <th>Worker</th>
            <th class="right">Reference Hours</th>
            <th class="right">Official Hours</th>
            <th class="right">Delta</th>
          </tr>
        </thead>
        <tbody id="mmTbody"></tbody>
      </table>
      <div class="note">
        Reference hours are employee-submitted and not billable. Use this page to spot discrepancies before payroll/invoicing issues.
      </div>
    </div>
  </div>

  <script>
    (function(){
      const data = (window.__DATA__ || null);
      const sub = document.getElementById('subline');
      if (!data) { sub.textContent = 'Missing data (window.__DATA__).'; return; }

      sub.textContent = `Order: ${data.orderId} | Week: ${data.periodStart} → ${data.periodEnd} (payroll week)`;

      // Reference rows (day-level)
      const ref = data.referenceRows || [];
      const refEmpty = document.getElementById('refEmpty');
      const refTable = document.getElementById('refTable');
      const refTbody = document.getElementById('refTbody');

      let refTotalMin = 0;
      if (ref.length === 0) {
        refEmpty.style.display = 'block';
      } else {
        refTable.style.display = 'table';
        ref.forEach(r => {
          refTotalMin += (r.totalMinutes || 0);
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${r.workerId}</td>
            <td>${r.workDate}</td>
            <td class="right">${r.totalMinutes ?? ''}</td>
            <td class="right">${(r.totalMinutes != null ? (r.totalMinutes/60).toFixed(2) : '')}</td>
            <td>${r.note ? String(r.note).slice(0,120) : ''}</td>
          `;
          refTbody.appendChild(tr);
        });
      }
      document.getElementById('refTotalMin').textContent = refTotalMin ? String(refTotalMin) : '';
      document.getElementById('refTotalHr').textContent  = refTotalMin ? (refTotalMin/60).toFixed(2) : '';

      // Official rows (entry-level)
      const off = data.officialRows || [];
      const offEmpty = document.getElementById('offEmpty');
      const offTable = document.getElementById('offTable');
      const offTbody = document.getElementById('offTbody');

      let offTotalHr = 0;
      if (off.length === 0) {
        offEmpty.style.display = 'block';
      } else {
        offTable.style.display = 'table';
        off.forEach(r => {
          offTotalHr += (r.totalHours || 0);
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${r.workerId}</td>
            <td class="right">${(r.totalHours ?? 0).toFixed(2)}</td>
            <td class="right">${r.createdAt ? String(r.createdAt).slice(0,19).replace('T',' ') : ''}</td>
          `;
          offTbody.appendChild(tr);
        });
      }
      document.getElementById('offTotalHr').textContent = offTotalHr ? offTotalHr.toFixed(2) : '';

      // Mismatch summary (worker-level)
      const mm = data.mismatches || [];
      const mmEmpty = document.getElementById('mmEmpty');
      const mmTable = document.getElementById('mmTable');
      const mmTbody = document.getElementById('mmTbody');

      if (mm.length === 0) {
        mmEmpty.style.display = 'block';
      } else {
        mmTable.style.display = 'table';
        mm.forEach(r => {
          const delta = (r.refHours - r.offHours);
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${r.workerId}</td>
            <td class="right">${r.refHours.toFixed(2)}</td>
            <td class="right">${r.offHours.toFixed(2)}</td>
            <td class="right ${(Math.abs(delta) >= 0.25) ? 'warn' : 'ok'}">${delta.toFixed(2)}</td>
          `;
          mmTbody.appendChild(tr);
        });
      }
    })();
  </script>
</body>
</html>